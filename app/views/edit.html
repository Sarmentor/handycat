<div ng-controller="TabsCtrl">
    <cat-nav></cat-nav>
    <!-- TODO: show the relevant content when the tab is active - put inside tab.content? -->
    <!-- TODO: add feature where dragging a word or phrase to target area translates it automatically -->
    <!-- UPDATE: use glossary for the 'add word' feature -->
    <!-- TODO: get the TM matches for the source segment -->

    <!-- translation area -->
    <div class="edit-area-wrapper" ng-controller="ContentAreaCtrl" ng-show="tabs[0].active">

        <div class="segment row" ng-controller="SegmentAreaCtrl" ng-repeat="seg in segments" index="$index"
             ng-init="segment = seg; init($index)">
            <a id="segment-{{$index}}"></a>
            <p class="segment-index-label">Segment Index: {{$index}} <span class="segment-finished" ng-show="segmentState.completed">Complete</span></p>

            <div class="bottom-margin" ng-click="activate($index)">
                <div class="row">
                    <!-- used with $anchorScroll from ContentAreaCtrl -->
                    <!-- TODO: prevent $anchorScroll from reloading the ng-repeat -->

                    <div class="col-sm-6 bottom-margin">
                        <div class="row">
                            <div class="col-xs-11">
                                <div ng-show="segmentState.completed" class="ace_editor target segment-finished-target">
                                    <p>{{segment.source}}</p>
                                </div>
                                <div ng-hide="segmentState.completed"  class="content-card">
                                    <div class="source">
                                        <source-area ng-init="setSource(segment.source)" source-sentence="segment.source"></source-area>
                                        <div class="row">
                                        </div>
                                    </div>
                                </div>
                                <!-- For the named-entity tagger -->
                                <!--<button class="btn btn-primary" ng-click="linkSourceEntities(); toggleToolbar();">Tag Entities</button>-->
                            </div>
                        </div>
                    </div>
                    <div ng-controller="AceCtrl" class="col-sm-6">
                        <div class="row">
                            <div ng-show="segmentState.completed" class="ace_editor target segment-finished-target">
                                <p>{{segment.target}}</p>
                            </div>
                            <div ng-hide="segmentState.completed" class="editor-area">
                                <div class="col-xs-11">
                                    <div index="{{$index}}" class="content-card">
                                        <!-- the ace editor -->
                                        <div class="ace_editor target" id="ace_editor-{{$index}}" ng-model="segment.target" ui-ace="{ onLoad : aceLoaded }"></div>
                                        <!--<div chars class="sample-show-hide" collapsed="showSpecialChars" special="germanChars" selected="insertChar(char)" ></div>-->
                                    </div>
                                </div>
                                <div class="reorder-toolbar col-xs-1 move-left" ng-show="isActive.active">
                                  <button logger="edit-mode-switch" tooltip="switch edit mode" tooltip-placement="right" ng-click="changeEditMode()" ng-disabled="segmentState.completed" class="btn btn-primary mode-glyph">
                                        <span>E</span>
                                  </button>
                                  <button logger="edit-mode-next" tooltip="next token" tooltip-placement="right" ng-click="selectNextRange()" ng-disabled="segmentState.completed" class="btn btn-primary mode-glyph">
                                      <span style="font-size: 7px" class="glyphicon glyphicon-arrow-right"></span>
                                  </button>
                                  <button logger="edit-mode-move" tooltip="move range" tooltip-placement="right" ng-click="moveCurrentEditRange()" ng-disabled="segmentState.completed" class="btn btn-primary mode-glyph">
                                      <span style="font-size: 7px" class="ion-arrow-move"></span>
                                  </button>
                                </div>
                            </div>
                        </div>

                        <!-- TODO: use the 'currentToken' property on the AceCtrl instead of 'selectedToken' -->
                        <div collapse="false" ng-show="isActive.active">
                            <div class="row">
                                <div class="col-xs-1">
                                    <!--<button ng-click="changeTokenNumber()" tooltip="change the number of the selected phrase" ng-disabled="segmentState.completed" class="btn btn-primary morph-glyph" tooltip-placement="bottom">-->
                                    <button logger="change-number" number-popover ng-click="togglePopover()" ng-disabled="segmentState.completed" class="btn btn-primary morph-glyph" tooltip-placement="bottom">
                                        <span class="ion-pound" ng-show="!changeNumberWorking"></span>
                                        <i ng-show="changeNumberWorking" class="ion-loading-b"></i>
                                    </button>
                                </div>
                                <div class="col-xs-1">
                                    <button logger="change-gender" gender-popover ng-click="togglePopover()" type="button" class="btn btn-primary morph-glyph" ng-disabled="segmentState.completed" tooltip-placement="bottom">
                                        <!--<button gender-popover ng-click="togglePopover()" ng-click="changeTokenGender()" type="button" class="btn btn-primary morph-glyph" ng-disabled="segmentState.completed" tooltip="change gender of the selected phrase" tooltip-placement="bottom">-->
                                        <span class="ion-male"></span>
                                        <i ng-show="changeGenderWorking" class="ion-loading-b"></i>
                                    </button>
                                </div>
                                <div class="col-xs-1">
                                    <button logger="change-case" case-popover ng-click="togglePopover()" type="button" class="btn btn-primary morph-glyph" ng-disabled="segmentState.completed" tooltip-placement="bottom">
                                        <span class="ion-ios7-briefcase"></span>
                                        <i ng-show="changeCaseWorking" class="ion-loading-b"></i>
                                    </button>
                                </div>
                                <div class="col-xs-offset-1 col-xs-1 text-right">
                                    <button logger="open-help" ng-click="openHelp()" tooltip="show help" tooltip-placement="bottom" ng-disabled="segmentState.completed" class="btn btn-primary cat-glyph"><span class="glyphicon glyphicon-question-sign"></span></button>
                                </div>
                                <div class="col-xs-1 text-right">
                                    <button logger="copy-source-punctuation" ng-click="copySourcePunctuation()" tooltip="copy punctuation from source" tooltip-placement="bottom" ng-disabled="segmentState.completed" class="btn btn-primary cat-glyph"><span class="glyphicon glyphicon-share-alt"></span></button>
                                </div>
                                <div class="col-xs-1 text-right">
                                    <button logger="toggle-toolbar" ng-click="toggleToolbar()" tooltip="toggle toolbar" tooltip-placement="bottom" ng-disabled="segmentState.completed" class="btn btn-primary cat-glyph"><span class="glyphicon glyphicon-wrench"></span></button>
                                </div>
                                <div class="col-xs-1 text-right">
                                    <!--<button ng-click="nextMTSuggestion()" tooltip="next MT suggestion" class="btn btn-primary cat-glyph"><span class="glyphicon glyphicon-flash"></span></button>-->
                                    <button logger="remove-extra-whitespace" ng-click="removeExtraWhitespace()" tooltip="remove extra whitespace" tooltip-placement="bottom" ng-disabled="segmentState.completed" class="btn btn-primary cat-glyph"><span class="glyphicon glyphicon-flash"></span></button>
                                </div>
                                <div class="col-xs-1 text-right">
                                    <button logger="clear-editor" ng-click="clearEditor()" tooltip="reject MT output" tooltip-placement="bottom" ng-disabled="segmentState.completed" class="btn btn-primary cat-glyph"><span class="glyphicon glyphicon-remove"></span></button>
                                </div>
                                <div class="col-xs-1 text-right">
                                    <button logger="segment-finished" ng-click="segmentFinished($index)" ng-disabled="segmentState.completed" class="btn btn-primary cat-glyph"><span class="glyphicon glyphicon-ok-sign"></span></button>
                                </div>
                                <!--<button ng-click="showSpecialChars = !showSpecialChars" class="btn btn-primary pull-right"><span>Show special</span></button>-->
                            </div>
                        </div>
                    </div>
                </div>
                <!-- The tools for editing -->
                <!--<div class="ace-toolbar container" ng-show="toolbarOpen" collapse="toolbarOpen">-->
                <div class="info-toolbar" collapse="isCollapsed['collapsed'] || segmentState.completed" ng-show="isActive.active">
                    <div
                        class="translation-toolbar"
                    >
                    <!-- Working - move to tabset -->
                    <!-- Working - Add smart pluralize here first, then move to the edit area -->
                    <!-- TODO - make tabs active based on edit-area interactions -->
                        <tabset>
                            <tab heading="Glossary" ng-click="">
                                <input type="text" ng-model="glossary.glossaryQuery" placeholder="Enter a search query..." />
                                <button logger="query-glossary" ng-click="queryGlossary(glossary.glossaryQuery)" class="glossary-search btn btn-success"><span class="glyphicon glyphicon-search"></span></button>
                                <div class="search-result"
                                     ng-repeat="glossaryMatch in glossaryMatches"
                                     ng-click="insertText(glossaryMatch)"
                                     ng-show="glossaryMatches"
                                >{{glossaryMatch}}</div>

                                <div ng-hide="glossaryMatches !== undefined"><p>Error: Unable to access the glossary service.</p></div>
                                <div ng-show="glossaryMatches.length === 0"><p>No matches found for term: <b>{{ glossary.glossaryQuery }}</b></p></div>
                            </tab>
                            <tab heading="Concordance" ng-click="">
                                <input type="text" ng-model="concordanceQuery" placeholder="Enter a search query..." />
                                <button logger="concordance-query" ng-click="queryConcordancer(concordanceQuery, queryLang)" class="btn btn-success"><span class="glyphicon glyphicon-search"></span></button>
                                <div class="btn-group">
                                    <button type="button" class="btn btn-primary lang-select" btn-radio="'en'" ng-model="queryLang">EN</button>
                                    <button type="button" class="btn btn-primary lang-select" btn-radio="'de'" ng-model="queryLang">DE</button>
                                </div>
                                <div class="search-result"
                                     ng-repeat="concordanceMatch in concordanceMatches"
                                     ng-bind-html="getSnippet({{concordanceMatch}})"
                                     ng-hide="concordancerError"
                                ></div>

                                <div ng-show="concordancerError"><p>Error: Unable to access the concordance service.</p></div>
                            </tab>
                            <tab heading="WordForms">
                                <div class="word-forms">
                                    <div
                                            ng-repeat="word in otherWordForms"
                                    >
                                        <button logger="word-forms-replace" class="btn btn-default" ng-click="replaceSelection(word)">{{word}}</button>
                                    </div>
                                </div>
                            </tab>
                            <tab heading="Edit history">
                                <div class="edit-history">
                                    <p>List of edits performed in this segment</p>

                                    <div ng-repeat="edit in editHistory">
                                        {{edit.description}} <button ng-click="propagateEdit($index)">Propagate</button>
                                    </div>
                                </div>
                            </tab>
                            <tab heading="Entities">
                                <div class="named-entities">
                                    <div>
                                        <div>Entity: <a ng-href="http://dbpedia.org/resource/{{entities.currentEntity.name}}">{{entities.currentEntity.name}}</a></div>
                                        <div class="surface-form" ng-repeat="sf in entities.currentEntity.surfaceForms | orderBy:'-count'">
                                            <!-- on click, insert entity -->
                                            <div ng-click="insertSurfaceForm(sf.name)">{{sf.name}}: {{sf.count}}</div>
                                        </div>
                                    </div>
                                </div>
                            </tab>
                        </tabset>

                    </div>
                </div>
                <hr/>
            </div>
        </div>
    <textarea rows="20" cols="120">{{ xliff_content }}</textarea>
    </div>

    <div ng-show="checkTranslationCompleted()" id="footmsg">
        <h2>Translation completed!</h2>
    </div>

    <div ng-controller="StatsController">
        <p>Stats</p>
        <div ng-repeat="s in log">
            <p>{{s[3]}}: {{s[0]}} {{s[1]}} {{s[2]}}</p>
        </div>
    </div>
</div>